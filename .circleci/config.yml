version: 2.1
orbs:
  codecov: codecov/codecov@1.0.4
jobs:
  checkout:
    steps:
      - checkout
  pr_checkout:
    steps:
      - run:
          name: Get PR target branch.
          command: |
            CIRCLECI_TARGET_BRANCH=$(curl -s https://api.github.com/repos/deeteecee/circleci-demo-java-spring/pulls/1 | jq --raw-output '.base.ref')
            echo "Github target branch: $CIRCLECI_TARGET_BRANCH"
      - checkout
      - run: git merge $CIRCLECI_TARGET_BRANCH
  build:
    working_directory: ~/circleci-demo-java-spring

    docker:
      - image: circleci/openjdk:8-jdk-stretch
      - image: circleci/postgres:9.6.3-alpine
        environment:
          POSTGRES_USER: root
          POSTGRES_DB: circle_test

    steps:
      - restore_cache:
          key: circleci-demo-java-spring-{{ checksum "pom.xml" }}
      
      - run: mvn dependency:go-offline
      
      - save_cache:
          paths:
            - ~/.m2
          key: circleci-demo-java-spring-{{ checksum "pom.xml" }}
      
      - run: mvn package
      
      - store_test_results:
          path: target/surefire-reports
      
      - codecov/upload:
          conf: codecov.yml 
          file: src/target/jacoco-reports
workflows:
  version: 2
  branch_build:
    - checkout
    - build
  pr_build:
    - pr_checkout
    - build
